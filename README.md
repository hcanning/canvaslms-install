Ubuntu 22.04 LTS / 8 GB Memory / 160 GB Disk / NYC3 / DigitalOcean
start at
`root@ubuntu-s-4vcpu-8gb-nyc3-01:/`
`sudo adduser sysadmin`
`sudo usermod -aG sudo sysadmin`
`sudo adduser canvasuser` (can try .. `sudo adduser --disabled-password --gecos canvas canvasuser`)
`su sysadmin`
`sudo apt-get install postgresql-14`
as root user
`su root`
`sudo -u postgres createuser $USER`
`sudo -u postgres psql -c "alter user $USER with superuser" postgres`
`sudo -u postgres createuser canvas --no-createdb \ --no-superuser --no-createrole --pwprompt`
`sudo -u postgres createdb canvas_production --owner=canvas`
as sysadmin user
`su sysadmin`
`sudo apt-get install git-core`
<!-- installs to /home/sysadmin/ -->
`git clone https://github.com/instructure/canvas-lms.git canvas `
`cd var/canvas`
`git checkout prod`
as sysadmin user
`su sysadmin`
`sudo mkdir -p /var/canvas`
`sudo chown -R sysadmin /var/canvas`
`cd ~/canvas`
`ls`
`cp -av . /var/canvas`
<!-- sysadmin@ubuntu-s-4vcpu-8gb-nyc3-01:/var/canvas$ -->
`cd /var/canvas`
`ls`
as root user
`su root`
`sudo apt-get install software-properties-common`
`sudo add-apt-repository ppa:instructure/ruby`
`sudo apt-get update -y`
`sudo apt-get install ruby3.4 ruby3.4-dev zlib1g-dev libxml2-dev \ libsqlite3-dev postgresql libpq-dev \ libxmlsec1-dev libyaml-dev libidn11-dev curl make g++`
`curl -sL https://deb.nodesource.com/setup_20.x | sudo -E bash -`
`sudo apt-get install nodejs`
`sudo npm install -g npm@latest`
as sysadmin user
`su sysadmin`
`cd /var/canvas`
`sudo gem install bundler`
`bundle config set --local path vendor/bundle`
`bundle install`
`sudo apt-get update`
`sudo npm install -g yarn@1.19.1` (specifically 1.19.1)
`yarn install`
Database
`for config in amazon_s3 database vault_contents \ delayed_jobs domain file_store outgoing_mail security external_migration; \ do cp config/$config.yml.example config/$config.yml; done cp config/dynamic_settings.yml.example config/dynamic_settings.yml nano config/dynamic_settings.yml`
<!-- change canvas pass -->
`cp config/database.yml.example config/database.yml`
`nano config/database.yml` (match user and pass)
`cp config/outgoing_mail.yml.example config/outgoing_mail.yml`
`nano config/outgoing_mail.yml`
`cp config/domain.yml.example config/domain.yml`
`nano config/domain.yml` (match domain)
<!-- update encrypt key -->
`cp config/security.yml.example config/security.yml`
`nano config/security.yml` (update key)
`yarn gulp rev`
`RAILS_ENV=production bundle exec rake db:initial_setup`
`mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands`
`touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss`
`touch Gemfile.lock`
`touch log/production.log`
`sudo chown -R canvasuser config/environment.rb log tmp public/assets \ app/stylesheets/_brandable_variables_defaults_autogenerated.scss \ app/stylesheets/brandable_css_brands Gemfile.lock config.ru`
`RAILS_ENV=production bundle exec rake canvas:compile_assets` (allow around 11 mins to run)
`sudo chown -R canvasuser public/dist/brandable_css`
`sudo chown canvasuser config/_.yml`
`sudo chmod 400 config/_.yml`
`sudo apt-get install apache2`
`sudo apt-get install -y dirmngr gnupg apt-transport-https ca-certificates`
`sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7`
`sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger $(lsb_release -cs) main > /etc/apt/sources.list.d/passenger.list'`
`sudo apt-get update`
`sudo apt-get install -y libapache2-mod-passenger`
`sudo a2enmod rewrite`
`sudo a2enmod passenger`
`sudo a2enmod ssl`
`sudo unlink /etc/apache2/sites-enabled/000-default.conf`
`cd /etc/apache2/sites-enabled`
`sudo nano /etc/apache2/sites-available/canvas.conf`
add apache virtual host
```
<VirtualHost *:80>
  ServerName canvas.yoursite.com
  ServerAlias www.canvas.yoursite.com
  ServerAdmin i@hcann.io
  DocumentRoot /var/canvas/public
  RewriteEngine On
  RewriteCond %{HTTP:X-Forwarded-Proto} !=https
  RewriteCond %{REQUEST_URI} !^/health_check
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L]
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_access.log combined
  SetEnv RAILS_ENV production
  <Directory /var/canvas/public>
    Options All
    AllowOverride All
    Require all granted
  </Directory>
</VirtualHost>
# If you are only serving HTTP behind a HTTPS-terminating load balancer, skip the next VirtualHost
<VirtualHost *:443>
  ServerName canvas.yoursite.com
  ServerAlias www.canvas.yoursite.com
  ServerAdmin i@hcann.io
  DocumentRoot /var/canvas/public
  ErrorLog /var/log/apache2/canvas_errors.log
  LogLevel warn
  CustomLog /var/log/apache2/canvas_ssl_access.log combined
  SSLEngine on
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown
  # the following ssl certificate files are generated for you from the ssl-cert package.
  SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
  SetEnv RAILS_ENV production
  <Directory /var/canvas/public>
    Options All
    AllowOverride All
    Require all granted
  </Directory>
</VirtualHost>

```
`sudo a2ensite canvas` (required for LetsEncrypt certbot)
`sudo a2ensite canvas`
`cd /var/canvas`
`sudo apt-get install libapache2-mod-xsendfile`
`sudo apachectl -M | sort`
Redis
`sudo add-apt-repository ppa:redislabs/redis`
`sudo apt-get update`
`sudo apt-get install redis-server`
`sudo cp config/cache_store.yml.example config/cache_store.yml`
`sudo nano config/cache_store.yml`
replace with:
```
test:
  cache_store: redis_cache_store
development:
  cache_store: redis_cache_store
production:
  cache_store: redis_cache_store
```
`sudo chown canvasuser config/cache_store.yml`
`sudo chmod 400 config/cache_store.yml`
`sudo cp config/redis.yml.example config/redis.yml`
`sudo nano config/redis.yml`
replace with:
```

test:
  url:
    - redis://localhost:6379/2
development:
  url:
    - redis://localhost:6379/1
production:
  url:
    - redis://localhost:6379/0

```
`sudo chown canvasuser config/redis.yml`
`sudo chmod 400 config/redis.yml`
`sudo ln -s /var/canvas/script/canvas_init /etc/init.d/canvas_init`
`sudo update-rc.d canvas_init defaults`
`sudo /etc/init.d/canvas_init start`
LetsEncrypt
`sudo apt update`
`sudo apt install certbot python3-certbot-apache`
`sudo certbot --apache`
`sudo systemctl restart apache2`
website
Navigate to your site (allow 3 mins to load initially)
https://canvas.yoursite.com
Login: email and password
Start using
`su sysadmin`
`cd /var/canvas/`
`sudo /etc/init.d/canvas_init restart` (restore snapshot to droplet and run)
